!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs/Subject"),require("rxjs/Observable")):"function"==typeof define&&define.amd?define(["exports","rxjs/Subject","rxjs/Observable"],t):t((e.ng=e.ng||{},e.ng.ngxStomp=e.ng.ngxStomp||{}),e.rxjs_Subject,e.rxjs_Observable)}(this,function(e,t,n){"use strict";var r,o=function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),i=function(){function e(e,t,n){this._id=e,this._destination=t,this._messages=n}return Object.defineProperty(e.prototype,"subscriptionId",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"destination",{get:function(){return this._destination},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messages",{get:function(){var e=this;return this._messages.filter(function(t){return t.subscriptionId==e.subscriptionId})},enumerable:!0,configurable:!0}),e}();!function(e){e[e.ACK=0]="ACK",e[e.NACK=1]="NACK",e[e.ABORT=2]="ABORT",e[e.BEGIN=3]="BEGIN",e[e.COMMIT=4]="COMMIT",e[e.CONNECT=5]="CONNECT",e[e.CONNECTED=6]="CONNECTED",e[e.DISCONNECT=7]="DISCONNECT",e[e.MESSAGE=8]="MESSAGE",e[e.RECEIPT=9]="RECEIPT",e[e.SUBSCRIBE=10]="SUBSCRIBE",e[e.UNSUBSCRIBE=11]="UNSUBSCRIBE",e[e.SEND=12]="SEND",e[e.ERROR=13]="ERROR"}(r||(r={}));var s=function(){function e(e,t,n){if(this._body=null,!e)throw new Error("ArgumentNullException: 'command'");this._command=e,this._body=t,this._headers=n?new Map(n):new Map}return Object.defineProperty(e.prototype,"command",{get:function(){return this._command},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"body",{get:function(){return this._body},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bodyJson",{get:function(){return this._body?JSON.parse(this._body):null},enumerable:!0,configurable:!0}),e.prototype.getHeader=function(e){return this._headers.get(e)},e.prototype.getRequiredHeader=function(e){var t=this.getHeader(e);if(t)return t;throw new Error("The required header "+e+" was not present in the frame!")},e.prototype.setHeader=function(e,t){this._headers.set(e,t)},e.prototype.foreachHeader=function(e){this._headers.forEach(e)},e.build=function(t,n,r){return new e(t,r,n)},Object.defineProperty(e.prototype,"headers",{get:function(){return this._headers},enumerable:!0,configurable:!0}),e}(),a=function(e){function t(t){return e.call(this,t.command,t.body,t.headers)||this}return o(t,e),Object.defineProperty(t.prototype,"messageId",{get:function(){return this.getRequiredHeader("message-id")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"destination",{get:function(){return this.getRequiredHeader("destination")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"subscriptionId",{get:function(){return this.getRequiredHeader("subscription")},enumerable:!0,configurable:!0}),t}(s),c=function(e){function t(t,n){var o=e.call(this,r.ERROR,null!=n?n.body:null,null!=n?n.headers:null)||this;return t&&o.setHeader("message",t),o}return o(t,e),Object.defineProperty(t.prototype,"errorMessage",{get:function(){return this.getHeader("message")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"errorDetail",{get:function(){return this.body},enumerable:!0,configurable:!0}),t}(s),u={LF:"\n",NULL:"\0"},p=function(){function e(){}return e.prototype.deserializeMessage=function(e){var t;if(e instanceof ArrayBuffer){var n=new Uint8Array(e);console.log("--- got data length: ",n.length);var r=[];n.forEach(function(e){return r.push(String.fromCharCode(e))}),t=r.join("")}else t=e;return t===u.LF?void console.log("<<< heart-beat received"):this.deserializeFrames(t)},e.prototype.deserializeFrames=function(e){for(var t=e.split(""+u.NULL+u.LF+"*"),n={frames:[],partial:""},r=0;r<t.length-1;r++)n.frames.push(this.deserializeFrame(t[r]));var o=t[t.length-1];return o===u.LF||-1!==o.search(""+u.NULL+u.LF+"*$")?n.frames.push(this.deserializeFrame(t[t.length-1])):n.partial=o,n},e.prototype.deserializeFrame=function(e){try{for(var t=e.search("\n\r?\n\r?"),n=e.substring(0,t).split(u.LF),r=n.shift(),o=new Map,i="",a=0,c=n.reverse();a<c.length;a++){var p=c[a],h=p.indexOf(":");o.set(this.trim(p.substring(0,h)),this.trim(p.substring(h+1)))}var d=t+2;if(o.get("content-length")){var f=parseInt(o.get("content-length"));i=(""+e).substring(d,d+f)}else for(var b=null,l=0;l<e.length&&(b=e.charAt(l))!==u.NULL;l++)i+=b;return new s(this.parseCommand(r),i,o)}catch(t){throw console.warn("Failed to parse frame:",e),t}},e.prototype.parseCommand=function(e){if(!e)throw new Error("ArgumentNullException: commandStr was 'null' which is not a valid command string!");var t=r[e];if(!t)throw new Error("Could not parse command '"+e+"' into a STOMP command!");return t},e.prototype.trim=function(e){return e.replace(/^\s+|\s+$/g,"")},e}(),h=function(){function e(){}return e.prototype.serialize=function(t){var n=r[t.command],o=[n];t.body&&t.setHeader("content-length",e.getUTF8Length(t.body)+""),t.foreachHeader(function(e,t){return o.push(t+":"+e)});var i=o.join(u.LF),s=i+u.LF+u.LF;return t.body&&(s+=t.body),s+=u.NULL},e.getUTF8Length=function(e){return e?encodeURI(e).match(/%..|./g).length:0},e}(),d={VERSIONS:{V1_0:"1.0",V1_1:"1.1",V1_2:"1.2"},supportedVersions:"1.1,1.0",client:function(e,t){void 0===t&&(t=["v10.stomp","v11.stomp"]);var n=new WebSocket(e,t);return new b(n)}},f=function(){function e(){this.headers=new Map}return e}(),b=function(){function e(e){this.ws=e,this.frameSerializer=new h,this.frameDeserializer=new p,this.counter=0,this.connected=!1,this.heartbeat={outgoing:1e4,incoming:1e4},this.connectSubject=new t.Subject,this.receiptSubject=new t.Subject,this.messageSubject=new t.Subject,this.errorSubject=new t.Subject,this.maxWebSocketFrameSize=16384,this.subscriptions=new Map,this.ws.binaryType="arraybuffer",console.log("socket state:",e.readyState)}return Object.defineProperty(e.prototype,"receipts",{get:function(){return this.receiptSubject},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messages",{get:function(){return this.messageSubject},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"errors",{get:function(){return this.errorSubject},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onConnect",{get:function(){return this.connectSubject},enumerable:!0,configurable:!0}),e.prototype.connect=function(e){var t=this;e||(e=new f),e.headers||(e.headers=new Map),e.login&&e.headers.set("login",e.login),e.passcode&&e.headers.set("passcode",e.passcode),this.debug("Opening WebSocket..."),this.ws.onmessage=function(e){var n=t.frameDeserializer.deserializeMessage(e.data);t.serverActivity=Date.now(),n.frames.forEach(function(e){return t.handleFrame(e)})},this.ws.onclose=function(){var e="Lost connection to "+t.ws.url;t.debug(e),t.cleanup(),t.onError(new c(e))},this.ws.onopen=function(){t.debug("WebSocket opened. Attempting to connect to STOMP now...");var e=new Map;e.set("accept-version","1.2"),e.set("host","localhost"),t.transmit(r.CONNECT,e)}},e.prototype.disconnect=function(e,t){this.transmit(r.DISCONNECT,t),this.ws.onclose=null,this.ws.close(),this.cleanup(),e()},e.prototype.send=function(e,t){var n=new Map;n.set("destination",e),this.transmit(r.SEND,n,t)},e.prototype.subscribe=function(e,t){t||(t=new Map);var n=t.get("id")?t.get("id"):"sub-"+this.counter++;t.set("id",n);var o=new i(n,e,this.messages);return this.subscriptions.set(e,o),t.set("destination",e),t.set("ack","auto"),this.transmit(r.SUBSCRIBE,t),o},e.prototype.unsubscribe=function(e){var t=new Map;t.set("id",e.subscriptionId),this.subscriptions.delete(e.subscriptionId),this.transmit(r.UNSUBSCRIBE,t)},e.prototype.abort=function(e){var t=new Map;t.set("transaction",e),this.transmit(r.ABORT,t)},e.prototype.begin=function(e){var t=this,n=e||"tx-"+this.counter++,o=new Map;return o.set("transaction",n),this.transmit(r.BEGIN,o),{id:n,commit:function(){t.commit(n)},abort:function(){t.abort(n)}}},e.prototype.commit=function(e){var t=new Map;t.set("transaction",e),this.transmit(r.COMMIT,t)},e.prototype.ack=function(e,t){var n=new Map;n.set("id",e),t&&n.set("transaction",t),this.transmit(r.ACK,n)},e.prototype.nack=function(e,t){var n=new Map;n.set("id",e),t&&n.set("transaction",t),this.transmit(r.NACK,n)},e.prototype.cleanup=function(){this.connected=!1,clearInterval(this.pinger),clearInterval(this.ponger)},e.prototype.handleFrame=function(e){switch(e.command){case r.CONNECTED:this.debug("connected to server ",e.getHeader("server")),this.connected=!0,this.setupHeartbeat(e),this.connectSubject.next(e);break;case r.MESSAGE:this.messageSubject.next(new a(e));break;case r.RECEIPT:this.receiptSubject.next(e);break;case r.ERROR:this.onError(new c(null,e)),this.debug("error received: ",e);break;default:throw new Error("not supported STOMP command '"+e.command+"'")}},e.prototype.onError=function(e){this.errorSubject.next(e)},e.prototype.transmit=function(e,t,n){var r=s.build(e,t,n),o=this.frameSerializer.serialize(r);for(this.debug(">>> ",o);o.length>this.maxWebSocketFrameSize;)this.ws.send(o.substring(0,this.maxWebSocketFrameSize)),o=o.substring(this.maxWebSocketFrameSize),this.debug("remaining = ",o.length);this.ws.send(o)},e.prototype.setupHeartbeat=function(e){var t=this;if(e.getHeader("version")&&e.getHeader("version")!==d.VERSIONS.V1_0){var n=e.getHeader("heart-beat").split(",").map(parseInt),r=n[0],o=n[1];if(this.heartbeat.outgoing>0&&o>0){var i=Math.max(this.heartbeat.outgoing,o);this.debug("Check PING every "+i+"ms"),this.pinger=setInterval(function(){t.sendHeartBeat()},i)}if(this.heartbeat.incoming>0&&r>0){var s=Math.max(this.heartbeat.incoming,r);this.debug("check PONG every "+s+"ms"),this.ponger=setInterval(function(){var e=Date.now()-t.serverActivity;e>2*s&&(t.debug("Did not receive server activity for the last "+e+"ms"),t.ws.close())},s)}}},e.prototype.sendHeartBeat=function(){this.ws.send(u.LF),this.debug(">>> PING")},e.prototype.debug=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];console.log(e,t)},e}(),l=function(){function e(e){this.connect(e)}return Object.defineProperty(e.prototype,"messages",{get:function(){return this.socketChannel},enumerable:!0,configurable:!0}),e.prototype.send=function(e){this.socket.readyState===WebSocket.OPEN&&this.socket.send(e)},e.prototype.close=function(){this.socket.close()},e.prototype.connect=function(e){this.socketChannel||(this.socket=new WebSocket(e),this.socketChannel=this.create(this.socket))},e.prototype.create=function(e){return n.Observable.create(function(t){return e.onmessage=t.next.bind(t),e.onerror=t.error.bind(t),e.onclose=t.complete.bind(t),e.close.bind(e)})},e}();e.Stomp=d,e.WebsocketRx=l,Object.defineProperty(e,"__esModule",{value:!0})});